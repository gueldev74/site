<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAC ULTIMATE | ARCHITECT</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100;400;700&family=Space+Grotesk:wght@300;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
/* --- CORE AESTHETICS --- */
:root { --bg: #030303; --panel: #0a0a0a; --border: #1a1a1a; --acc: #ffffff; }
body { background-color: var(--bg); color: #888; font-family: 'JetBrains Mono', monospace; overflow: hidden; }

/* UTILS */
.font-display { font-family: 'Space Grotesk', sans-serif; }
.glass { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(10px); }
.mono-box { border: 1px solid var(--border); background: var(--panel); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
.mono-box:hover { border-color: #333; }

/* INPUTS */
.clean-inp { 
    background: transparent; border: none; border-bottom: 1px solid #333; 
    color: white; width: 100%; padding: 15px 0; font-size: 14px; outline: none; transition: 0.3s; 
}
.clean-inp:focus { border-color: white; }
.clean-inp::placeholder { color: #333; text-transform: uppercase; font-size: 10px; letter-spacing: 2px; }

/* BUTTONS */
.btn-elite { 
    background: white; color: black; border: 1px solid white; padding: 12px; 
    font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; 
    cursor: pointer; transition: 0.2s; position: relative; overflow: hidden;
}
.btn-elite:hover { background: black; color: white; }
.btn-elite:disabled { background: #222; border-color: #222; color: #555; cursor: not-allowed; }

.tab-btn {
    background: transparent; color: #444; border: 1px solid #222; padding: 10px;
    font-size: 10px; text-transform: uppercase; cursor: pointer; transition: 0.3s;
}
.tab-btn.active { border-color: white; color: white; background: #080808; }

/* LOGS & SCROLL */
.logs-container { 
    height: 150px; overflow-y: auto; font-size: 10px; color: #444; 
    border-top: 1px solid #111; padding-top: 15px; mask-image: linear-gradient(to bottom, transparent, black 10%);
}
::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-thumb { background: #333; }
::-webkit-scrollbar-track { background: transparent; }

/* ANIMATIONS */
@keyframes pulse-white { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }
.status-dot { width: 6px; height: 6px; border-radius: 50%; background: #333; transition: 0.5s; }
.status-dot.online { background: #fff; box-shadow: 0 0 10px #fff; animation: pulse-white 2s infinite; }
</style>

</head>
<body class="h-screen w-screen flex flex-col items-center justify-center relative">

<div class="absolute inset-0 z-0 opacity-[0.03]" style="background-image: linear-gradient(#333 1px, transparent 1px), linear-gradient(90deg, #333 1px, transparent 1px); background-size: 40px 40px;"></div>

<div class="w-full max-w-lg z-10 p-6">
    
    <div class="flex justify-between items-end mb-8 select-none">
        <div>
            <h1 class="font-display text-4xl text-white font-bold tracking-tighter leading-none">CAC<br><span class="text-zinc-600">ULTIMATE</span></h1>
            <p class="text-[9px] uppercase tracking-[0.3em] mt-2 text-zinc-500">Cloud Extraction Architecture</p>
        </div>
        <div class="flex flex-col items-end">
            <div class="flex items-center gap-2 mb-1">
                <span id="status-text" class="text-[9px] font-bold tracking-widest text-zinc-600">SYSTEM OFFLINE</span>
                <div id="status-dot" class="status-dot"></div>
            </div>
            <div class="text-[9px] text-zinc-800 font-mono">V7.5 SECURE</div>
        </div>
    </div>

    <div id="network-stats" class="hidden mb-6 flex gap-2">
        <div class="mono-box flex-1 p-3 flex justify-between items-center">
            <span class="text-[9px] uppercase tracking-widest">Active Workers</span>
            <span id="worker-count" class="text-white font-bold text-xs">0</span>
        </div>
        <div class="mono-box flex-1 p-3 flex justify-between items-center">
            <span class="text-[9px] uppercase tracking-widest">Queue Pos</span>
            <span id="queue-pos" class="text-white font-bold text-xs">-</span>
        </div>
    </div>

    <div id="auth-layer" class="mono-box p-8">
        <div class="mb-6">
            <label class="text-[9px] uppercase tracking-widest text-zinc-500 block mb-2">Access Credentials</label>
            <input type="password" id="key-input" class="clean-inp text-center tracking-[0.5em]" placeholder="•••• •••• ••••">
        </div>
        <button onclick="login()" id="btn-login" class="btn-elite w-full">INITIALIZE SESSION</button>
    </div>

    <div id="dash-layer" class="hidden animate-in fade-in zoom-in duration-500">

        <div id="license-info" class="hidden mb-6 mono-box p-3 flex justify-between items-center border-l-2 border-zinc-700">
            <span class="text-[9px] uppercase tracking-widest text-zinc-500">LICENSE TIME</span>
            <span id="time-remaining" class="text-white font-bold text-xs font-mono">CALCULATING...</span>
        </div>
        
        <div class="flex gap-4 mb-8">
            <button onclick="setTab('CREATOR')" id="tab-creator" class="tab-btn active flex-1">By Creator</button>
            <button onclick="setTab('CODES')" id="tab-codes" class="tab-btn flex-1">Hex Codes</button>
        </div>

        <div class="mono-box p-8 mb-4 relative">
            <div class="absolute top-4 right-4 text-[9px] text-zinc-700">TARGET PARAMETER</div>
            <input type="text" id="target-input" class="clean-inp text-lg" placeholder="ENTER USERNAME">
        </div>

        <div class="flex gap-4 mb-4">
            <button onclick="startTask()" id="btn-start" class="btn-elite flex-1">EXECUTE DUMP</button>
        </div>

        <div id="result-panel" class="hidden mono-box p-6 border-l-2 border-white mb-4">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <div class="text-white text-xs font-bold tracking-widest">DATA PACKET READY</div>
                    <div class="text-[9px] mt-1">Processed <span id="item-count" class="text-white">0</span> Outfits • Plugin Compatible</div>
                </div>
                <i class="fa-solid fa-check text-white"></i>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="downloadFormatted()" class="bg-zinc-900 hover:bg-zinc-800 text-white p-2 text-[10px] font-mono border border-zinc-800 transition">DOWNLOAD .JSON</button>
                <button onclick="copyFormatted()" class="bg-zinc-900 hover:bg-zinc-800 text-white p-2 text-[10px] font-mono border border-zinc-800 transition">COPY DATA</button>
            </div>
        </div>

        <div class="logs-container font-mono" id="console">
            <div class="mb-1">> Protocol initialized.</div>
            <div class="mb-1 text-zinc-600">> Waiting for user input...</div>
        </div>
    </div>
</div>

<script>
    // CONFIGURAÇÕES DO SERVIDOR
    const BIN_ID_SERVER = "695c0336d0ea881f40566e09";
    const BIN_ID_KEYS = "69892e1143b1c97be96fd3d0"; // ID do JSON de Keys
    const MASTER_KEY = "$2a$10$uZJCOClc7V9uwqnCnJbXyuHynJ7fX7Z0l32pHbznLAtpLbjX7ABwS";

    let SERVER_URL = "";
    let CURRENT_TYPE = "CREATOR";
    let RAW_DATA = null;
    let PROCESSED_DATA = null;
    let LAST_FILENAME = "cac_ultimate.json";
    
    // --- GERADOR DE HWID NO BROWSER ---
    let HWID = localStorage.getItem("cac_hwid_v2");
    if (!HWID) {
        HWID = "CAC-" + Math.random().toString(36).substr(2, 9).toUpperCase() + "-" + Date.now().toString(36).toUpperCase();
        localStorage.setItem("cac_hwid_v2", HWID);
    }

    // --- SISTEMA DE LOGS ---
    function log(msg, type = 'normal') {
        const c = document.getElementById('console');
        const time = new Date().toLocaleTimeString().split(' ')[0];
        let colorClass = type === 'error' ? 'text-red-500' : (type === 'success' ? 'text-white' : 'text-zinc-500');
        c.innerHTML += `<div class="${colorClass} mb-1"><span class="opacity-30">[${time}]</span> ${msg}</div>`;
        c.scrollTop = c.scrollHeight;
    }

    // --- FUNÇÃO DE TEMPO GLOBAL ---
    async function getGlobalTime() {
        try {
            let r = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
            let d = await r.json();
            return d.datetime; 
        } catch(e) {
            return new Date().toISOString(); 
        }
    }

    // --- AUTH & KEY SYSTEM ---
    // --- FUNÇÃO DE CONTAGEM REGRESSIVA (NOVA) ---
    function startCountdown(endDate) {
        document.getElementById('license-info').classList.remove('hidden');
        
        const timer = setInterval(() => {
            const now = new Date().getTime();
            const distance = endDate.getTime() - now;

            if (distance < 0) {
                clearInterval(timer);
                document.getElementById("time-remaining").innerText = "EXPIRED";
                document.getElementById("time-remaining").classList.add("text-red-500");
                alert("SESSION EXPIRED. Please refresh.");
                location.reload();
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

            document.getElementById("time-remaining").innerText = `${days}d ${hours}h ${minutes}m`;
        }, 1000);
        
        // Executa uma vez imediatamente para não esperar 1 seg
        const now = new Date().getTime();
        const distance = endDate.getTime() - now;
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        document.getElementById("time-remaining").innerText = `${days}d ${hours}h ${minutes}m`;
    }

    // --- SISTEMA DE LOGIN ATUALIZADO ---
    async function login() {
        const key = document.getElementById('key-input').value.trim();
        const btn = document.getElementById('btn-login');
        
        if(!key) return;
        btn.disabled = true;
        btn.innerText = "AUTHENTICATING...";

        try {
            // 1. Busca URL do Servidor
            let rServer = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_SERVER}/latest`, {headers: {"X-Master-Key": MASTER_KEY}});
            let dataServer = await rServer.json();
            SERVER_URL = dataServer.record.server_url;

            // 2. Busca Banco de Dados de Keys
            let rKeys = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_KEYS}/latest`, {headers: {"X-Master-Key": MASTER_KEY}});
            let dataKeys = await rKeys.json();
            let record = dataKeys.record;
            let user = record.users[key];

            // --- VALIDAÇÃO 1: KEY EXISTE? ---
            if(!user) throw "KEY_NOT_FOUND";

            // Se for ADMIN, libera direto sem timer
            if(user.type === "admin") {
                log("Admin Access Granted.", 'success');
                unlockInterface();
                return;
            }

            const now = await getGlobalTime();
            const nowTime = new Date(now).getTime();

            // Pega o tempo definido no JSON (Se não tiver 'time', assume 1 dia por segurança)
            const durationDays = user.time || 1;
            const durationMs = durationDays * 24 * 60 * 60 * 1000;

            // --- CENÁRIO A: KEY JÁ ATIVADA ANTERIORMENTE ---
            if(user.start_date) {
                const startDate = new Date(user.start_date).getTime();
                const expirationDate = startDate + durationMs;

                // Validação 2: Expirou?
                if(nowTime > expirationDate) throw "KEY_EXPIRED";
                
                // Validação 3: HWID Bate?
                if(user.hwid !== HWID) throw "HWID_MISMATCH";

                // Sucesso: Inicia timer
                startCountdown(new Date(expirationDate));

            } else {
                // --- CENÁRIO B: PRIMEIRA VEZ (ATIVAR) ---
                log("First use detected. Activating key...", 'normal');
                
                user.hwid = HWID;
                user.start_date = now; // Salva data atual ISO
                
                // Atualiza JSONBin
                record.users[key] = user;
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_KEYS}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY },
                    body: JSON.stringify(record)
                });

                // Calcula expiração e inicia timer
                const expirationDate = new Date(now).getTime() + durationMs;
                startCountdown(new Date(expirationDate));
                
                log(`Key Bound to Device: ${HWID}`, 'success');
            }

            unlockInterface();
            startStatsPolling();

        } catch(e) {
            let msg = "UNKNOWN ERROR";
            
            if(e === "KEY_NOT_FOUND") {
                msg = "❌ The key is invalid or it does not exist.";
            } 
            else if(e === "KEY_EXPIRED") {
                msg = "❌ Your key has expired.\nGet a new one.";
            } 
            else if(e === "HWID_MISMATCH") {
                msg = "⚠️ The key exist but it's not linked on this browser.\n\n1. Try using the first browser you used to log in.\n2. Turn off VPN/PROXY\n3. If the error persists, please contact us on Discord so we can generate a new one. Also, please send proof of purchase.";
            } else {
                console.error(e);
            }
            
            log(msg, 'error');
            alert(msg); // Popup para o usuário ler com atenção
            
            btn.disabled = false;
            btn.innerText = "INITIALIZE SESSION";
        }
    }

    function unlockInterface() {
        document.getElementById('auth-layer').classList.add('hidden');
        document.getElementById('dash-layer').classList.remove('hidden');
        document.getElementById('network-stats').classList.remove('hidden');
        
        document.getElementById('status-dot').classList.add('online');
        document.getElementById('status-text').innerText = "SYSTEM ONLINE";
        document.getElementById('status-text').className = "text-[9px] font-bold tracking-widest text-white";
        
        log(`Connected to Core Node: ${SERVER_URL}`, 'success');
    }

    // --- TAB CONTROL ---
    window.setTab = function(type) {
        CURRENT_TYPE = type;
        document.getElementById('tab-creator').className = `tab-btn ${type === 'CREATOR' ? 'active' : ''}`;
        document.getElementById('tab-codes').className = `tab-btn ${type === 'CODES' ? 'active' : ''}`;
        document.getElementById('target-input').placeholder = type === 'CREATOR' ? "ENTER USERNAME" : "ENTER HEX CODES (SPACE SEPARATED)";
        resetDataUI();
    }

    function resetDataUI() {
        RAW_DATA = null;
        PROCESSED_DATA = null;
        document.getElementById('result-panel').classList.add('hidden');
        // Não reseta o botão aqui se ele estiver em cooldown
        const btn = document.getElementById('btn-start');
        if (btn.innerText === "EXECUTE DUMP") {
            btn.disabled = false;
        }
    }

    // --- WORKER & QUEUE STATS ---
    function startStatsPolling() {
        setInterval(async () => {
            try {
                let r = await fetch(`${SERVER_URL}/api/stats`, {headers: {"ngrok-skip-browser-warning": "true"}});
                let d = await r.json();
                
                if(d) {
                    document.getElementById('worker-count').innerText = d.active_workers || 0;
                    document.getElementById('queue-pos').innerText = d.queue_size || 0;
                }
            } catch(e) {}
        }, 5000); 
    }

    // --- CORE LOGIC (MODIFICADO PARA LIMITE DE 20) ---
    async function startTask() {
        const target = document.getElementById('target-input').value;
        if(!target) return log("Target undefined", 'error');

        resetDataUI();
        
        const btn = document.getElementById('btn-start');
        btn.disabled = true;
        btn.innerText = "PROCESSING...";
        log(`Requesting dump for: ${target}`);

        try {
            let payloadTarget = target;

            // LÓGICA DE LIMITE E CORTE (CODES)
            if(CURRENT_TYPE === 'CODES') {
                // Transforma string em array limpo
                let allCodes = target.replace(/,/g, ' ').split(/\s+/).filter(x => x);
                
                // Verifica limite de 20
                if (allCodes.length > 20) {
                    alert(`⚠️ LIMIT REACHED\n\nTo ensure stability, max 20 codes allowed per batch.\nThe system will process only the first 20 codes.`);
                    log(`Warning: Request trimmed from ${allCodes.length} to 20 codes.`, 'error');
                    
                    // Corta o array para os primeiros 20
                    allCodes = allCodes.slice(0, 20);
                }
                
                payloadTarget = allCodes;
            }

            let r = await fetch(`${SERVER_URL}/api/request`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "ngrok-skip-browser-warning": "true" },
                body: JSON.stringify({ type: CURRENT_TYPE, target: payloadTarget })
            });
            
            let d = await r.json();
            if(d.success) {
                log(`Task ID: ${d.task_id.substr(0,6)} initialized.`);
                poll(d.task_id);
            } else throw "Server Rejected";

        } catch(e) {
            log("Connection Failure (Server Offline?)", 'error');
            btn.disabled = false;
            btn.innerText = "EXECUTE DUMP";
        }
    }

    function poll(tid) {
        const interval = setInterval(async () => {
            try {
                let r = await fetch(`${SERVER_URL}/api/status/${tid}`, {headers: {"ngrok-skip-browser-warning": "true"}});
                let d = await r.json();

                if(d.status === "COMPLETED" && d.result_data) {
                    clearInterval(interval);
                    RAW_DATA = d.result_data;
                    processRawData(); 
                    
                    // Mostra Painel
                    document.getElementById('result-panel').classList.remove('hidden');
                    let itemCount = PROCESSED_DATA.outfits ? PROCESSED_DATA.outfits.length : 0;
                    document.getElementById('item-count').innerText = itemCount;
                    
                    LAST_FILENAME = `CAC_${tid.substr(0,5)}.json`;
                    log("Data received successfully.", 'success');

                    // --- ACIONA O COOLDOWN AO INVÉS DE LIBERAR IMEDIATAMENTE ---
                    activateCooldown(itemCount);
                }
            } catch(e) { }
        }, 1500);
    }

    // --- NOVA FUNÇÃO DE COOLDOWN ---
    function activateCooldown(count) {
        const btn = document.getElementById('btn-start');
        let seconds = 10; // Padrão mínimo

        // Regras de Tempo (Baseado no pedido)
        if (count <= 5) {
            seconds = 10;
        } else if (count <= 10) {
            seconds = 15;
        } else if (count <= 20) {
            seconds = 30;
        } else {
            // Caso seja creator mode e venha muuuita coisa
            seconds = 45; 
        }

        log(`Cooling down systems for ${seconds}s...`, 'normal');
        
        btn.disabled = true;
        
        // Timer Visual
        const timer = setInterval(() => {
            btn.innerText = `COOLDOWN (${seconds}s)`;
            seconds--;

            if (seconds < 0) {
                clearInterval(timer);
                btn.innerText = "EXECUTE DUMP";
                btn.disabled = false;
                log("System cooled down. Ready.", 'success');
            }
        }, 1000);
    }

    function processRawData() {
        if(RAW_DATA && RAW_DATA.outfits) {
            PROCESSED_DATA = RAW_DATA;
        } else if (Array.isArray(RAW_DATA)) {
            PROCESSED_DATA = { "outfits": RAW_DATA };
        } else {
            PROCESSED_DATA = { "outfits": [] };
        }
    }

    function downloadFormatted() {
        if(!PROCESSED_DATA) return;
        const blob = new Blob([JSON.stringify(PROCESSED_DATA, null, 4)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = LAST_FILENAME;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function copyFormatted() {
        if(!PROCESSED_DATA) return;
        navigator.clipboard.writeText(JSON.stringify(PROCESSED_DATA, null, 4));
        log("Data copied to clipboard.", 'success');
    }
</script>
</body>
</html>
