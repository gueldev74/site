<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAC CLOUD | FINAL</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body { background-color: #050505; color: #eee; font-family: monospace; }
    .box { border: 1px solid #333; background: #0a0a0a; box-shadow: 0 0 20px #000; }
    .inp { background: #000; border: 1px solid #333; color: white; width: 100%; padding: 12px; outline: none; transition: 0.3s; }
    .inp:focus { border-color: #00ff00; }
    .btn { background: #fff; color: #000; font-weight: bold; width: 100%; padding: 12px; cursor: pointer; transition: 0.2s; }
    .btn:hover { background: #ddd; }
    .btn:disabled { background: #333; color: #666; cursor: wait; }
    .logs { height: 180px; overflow-y: auto; border-top: 1px solid #333; padding: 10px; font-size: 11px; color: #00ff00; background: #000; }
    
    /* Scrollbar estilizada */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #333; }
</style>
</head>
<body class="h-screen flex items-center justify-center p-4">

<div class="w-full max-w-md box p-6">
    <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
        <div>
            <h1 class="text-2xl font-bold tracking-tighter">CAC CLOUD</h1>
            <p class="text-[10px] text-gray-500">DATA STREAM V7.0</p>
        </div>
        <div class="text-right">
            <div id="status-text" class="text-[10px] text-gray-500">OFFLINE</div>
            <div id="status-dot" class="w-2 h-2 bg-red-600 rounded-full inline-block ml-1"></div>
        </div>
    </div>

    <div id="auth-screen">
        <p class="text-xs text-gray-500 mb-2">AUTHENTICATION</p>
        <input type="password" id="key-input" class="inp mb-4" placeholder="ENTER ACCESS KEY">
        <button onclick="login()" id="btn-login" class="btn uppercase">Connect System</button>
    </div>

    <div id="dash-screen" class="hidden space-y-4">
        <div class="flex gap-2 text-xs mb-2">
            <button onclick="setType('CREATOR')" id="btn-creator" class="flex-1 bg-white text-black p-2 font-bold uppercase">Creator</button>
            <button onclick="setType('CODES')" id="btn-codes" class="flex-1 border border-gray-700 text-gray-500 p-2 uppercase hover:border-white transition">Codes List</button>
        </div>

        <div>
            <input type="text" id="target-input" class="inp" placeholder="Target Username...">
        </div>
        
        <button onclick="startTask()" id="btn-start" class="btn uppercase tracking-widest">Request Data Stream</button>

        <div id="result-area" class="hidden space-y-2 mt-4 bg-gray-900 p-4 border border-green-900">
            <div class="text-xs text-center text-green-400 font-bold mb-2 uppercase animate-pulse">✨ Stream Received Successfully</div>
            
            <div class="flex gap-2">
                <button onclick="downloadJSON()" class="flex-1 bg-green-600 text-white p-3 text-xs font-bold hover:bg-green-500 uppercase">
                    <i class="fas fa-download"></i> Download .JSON
                </button>
                <button onclick="copyJSON()" class="flex-1 border border-green-600 text-green-400 p-3 text-xs font-bold hover:bg-green-900 uppercase">
                    Copy Data
                </button>
            </div>
            <p class="text-[9px] text-center text-gray-500 mt-1">File generated locally in browser memory.</p>
        </div>

        <div class="logs font-mono" id="console">
            <div class="text-gray-500">> System Initialized.</div>
        </div>
    </div>
</div>

<script>
    // === CONFIGURAÇÃO (NÃO MEXER) ===
    const BIN_ID_SERVER = "695c0336d0ea881f40566e09";
    const BIN_ID_KEYS = "69892e1143b1c97be96fd3d0";
    const MASTER_KEY = "$2a$10$uZJCOClc7V9uwqnCnJbXyuHynJ7fX7Z0l32pHbznLAtpLbjX7ABwS";

    let SERVER_URL = "";
    let CURRENT_TYPE = "CREATOR";
    let LAST_DATA = null;
    let LAST_FILENAME = "dump.json";
    // HWID Persistente
    let HWID = localStorage.getItem("hwid_v7");
    if (!HWID) {
        HWID = "WEB-" + Math.random().toString(36).substr(2, 9).toUpperCase();
        localStorage.setItem("hwid_v7", HWID);
    }

    // --- FUNÇÕES DE LOG ---
    function log(msg, type = 'info') {
        const c = document.getElementById('console');
        const time = new Date().toLocaleTimeString().split(' ')[0];
        let color = type === 'error' ? 'text-red-500' : (type === 'success' ? 'text-green-400' : 'text-gray-300');
        c.innerHTML += `<div class="${color}"><span class="text-gray-600">[${time}]</span> ${msg}</div>`;
        c.scrollTop = c.scrollHeight;
    }

    // --- LOGIN ---
    async function login() {
        const key = document.getElementById('key-input').value;
        const btn = document.getElementById('btn-login');
        if (!key) return alert("Please enter a key");

        btn.disabled = true;
        btn.innerText = "CONNECTING...";

        try {
            log("Fetching Server Topology...");
            // 1. Pega URL do Ngrok
            let r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_SERVER}/latest`, {headers: {"X-Master-Key": MASTER_KEY}});
            let data = await r.json();
            SERVER_URL = data.record.server_url;
            
            // 2. Verifica Chave
            log("Verifying Credentials...");
            r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_KEYS}/latest`, {headers: {"X-Master-Key": MASTER_KEY}});
            data = await r.json();
            let user = data.record.users[key];

            if(!user) throw "Invalid Access Key";
            // Admin pula check de HWID
            if(user.type !== "admin" && user.hwid && user.hwid !== HWID) throw "HWID Mismatch (Key used elsewhere)";

            // Sucesso
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dash-screen').classList.remove('hidden');
            
            updateStatus(true);
            log(`Connected to Core: ${SERVER_URL}`);
            
        } catch(e) {
            alert(e);
            btn.disabled = false;
            btn.innerText = "CONNECT SYSTEM";
            log(e, 'error');
        }
    }

    function updateStatus(online) {
        const dot = document.getElementById('status-dot');
        const txt = document.getElementById('status-text');
        if(online) {
            dot.className = "w-2 h-2 bg-green-500 rounded-full inline-block ml-1 shadow-[0_0_8px_#0f0]";
            txt.innerText = "ONLINE";
            txt.className = "text-[10px] text-green-500 font-bold";
        } else {
            dot.className = "w-2 h-2 bg-red-600 rounded-full inline-block ml-1";
            txt.innerText = "DISCONNECTED";
            txt.className = "text-[10px] text-red-500";
        }
    }

    // --- SISTEMA DE TAREFAS ---
    function setType(t) {
        CURRENT_TYPE = t;
        const inp = document.getElementById('target-input');
        inp.placeholder = t === 'CREATOR' ? "Target Username..." : "Hex Codes (Space Separated)...";
        
        document.getElementById('btn-creator').className = t === 'CREATOR' 
            ? "flex-1 bg-white text-black p-2 font-bold uppercase" 
            : "flex-1 border border-gray-700 text-gray-500 p-2 uppercase hover:border-white transition";
        
        document.getElementById('btn-codes').className = t === 'CODES' 
            ? "flex-1 bg-white text-black p-2 font-bold uppercase" 
            : "flex-1 border border-gray-700 text-gray-500 p-2 uppercase hover:border-white transition";
    }

    async function startTask() {
        const target = document.getElementById('target-input').value;
        if(!target) return log("Target is empty", 'error');

        const btn = document.getElementById('btn-start');
        btn.disabled = true;
        document.getElementById('result-area').classList.add('hidden'); // Esconde resultado anterior
        log(`Initiating Dump: ${target}...`);

        try {
            // Tratamento de input
            let payloadTarget = target;
            if(CURRENT_TYPE === 'CODES') {
                payloadTarget = target.replace(/,/g, ' ').split(/\s+/).filter(x => x.length > 0);
            }

            // CORREÇÃO CRÍTICA 1: Header do Ngrok
            let r = await fetch(`${SERVER_URL}/api/request`, {
                method: "POST", 
                headers: {
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true" 
                },
                body: JSON.stringify({ type: CURRENT_TYPE, target: payloadTarget })
            });
            
            let d = await r.json();
            if(d.success) {
                log(`Task Created [ID: ${d.task_id.substr(0,6)}]`);
                poll(d.task_id);
            } else {
                throw "Server rejected request";
            }

        } catch(e) {
            log(`Network Error: ${e.message || e}`, 'error');
            btn.disabled = false;
        }
    }

    // --- POLLING IMORTAL ---
    function poll(tid) {
        let attempts = 0;
        const interval = setInterval(async () => {
            attempts++;
            try {
                // CORREÇÃO CRÍTICA 2: Bypass na tela de aviso do Ngrok
                let r = await fetch(`${SERVER_URL}/api/status/${tid}`, {
                    headers: { "ngrok-skip-browser-warning": "true" }
                });
                
                if(!r.ok) throw `HTTP ${r.status}`;
                
                let d = await r.json();

                if(d.status === "COMPLETED" && d.result_data) {
                    clearInterval(interval);
                    log("✅ DATA STREAM RECEIVED!", 'success');
                    
                    // Salva na memória
                    LAST_DATA = d.result_data;
                    LAST_FILENAME = `CAC_Dump_${tid.substr(0,8)}.json`;
                    
                    // Libera UI
                    document.getElementById('btn-start').disabled = false;
                    document.getElementById('result-area').classList.remove('hidden');
                    
                } else if (d.status === "PROCESSING") {
                    if(attempts % 5 === 0) log(`Worker is extracting data... (${d.worker || 'Unknown'})`);
                } else if (d.status === "QUEUED") {
                    if(attempts % 5 === 0) log(`Waiting for worker... (Pos: ${d.position})`);
                }

            } catch(e) {
                // Não cancela o polling se der erro temporário, apenas avisa
                console.warn("Poll glitch:", e);
                // Se der erro 10 vezes seguidas, aí sim para
                if(attempts > 120) { 
                    clearInterval(interval); 
                    log("Timeout: Worker took too long.", 'error');
                    document.getElementById('btn-start').disabled = false;
                }
            }
        }, 1500); // Checa a cada 1.5s
    }

    // --- DOWNLOAD & COPY ---
    function downloadJSON() {
        if(!LAST_DATA) return;
        const blob = new Blob([JSON.stringify(LAST_DATA, null, 4)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = LAST_FILENAME;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        log("File saved to device.");
    }

    function copyJSON() {
        if(!LAST_DATA) return;
        navigator.clipboard.writeText(JSON.stringify(LAST_DATA, null, 4))
            .then(() => log("JSON copied to clipboard!", 'success'))
            .catch(() => log("Failed to copy.", 'error'));
    }
</script>
</body>
</html>
