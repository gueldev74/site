<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAC CLOUD | JSON ONLY</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body { background-color: #050505; color: #eee; font-family: monospace; }
    .box { border: 1px solid #333; background: #0a0a0a; }
    .inp { background: #000; border: 1px solid #333; color: white; width: 100%; padding: 10px; }
    .btn { background: #fff; color: #000; font-weight: bold; width: 100%; padding: 10px; cursor: pointer; }
    .btn:hover { background: #ccc; }
    .btn:disabled { background: #333; color: #666; cursor: not-allowed; }
    .logs { height: 200px; overflow-y: auto; border-top: 1px solid #333; padding: 10px; font-size: 11px; color: #0f0; }
</style>
</head>
<body class="h-screen flex items-center justify-center p-4">

<div class="w-full max-w-md box p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-bold">CAC CLOUD <span class="text-xs text-yellow-500">JSON</span></h1>
        <div id="status-dot" class="w-3 h-3 bg-red-600 rounded-full"></div>
    </div>

    <div id="auth-screen">
        <input type="password" id="key-input" class="inp mb-4" placeholder="ACCESS KEY">
        <button onclick="login()" id="btn-login" class="btn">CONNECT TO CLOUD</button>
    </div>

    <div id="dash-screen" class="hidden space-y-4">
        <div class="flex gap-2 text-xs mb-2">
            <button onclick="setType('CREATOR')" id="btn-creator" class="flex-1 bg-white text-black p-2 font-bold">CREATOR</button>
            <button onclick="setType('CODES')" id="btn-codes" class="flex-1 border border-gray-700 text-gray-500 p-2">CODES LIST</button>
        </div>

        <input type="text" id="target-input" class="inp" placeholder="Username...">
        
        <button onclick="startTask()" id="btn-start" class="btn">REQUEST DUMP</button>

        <div id="download-area" class="hidden mt-4">
            <a id="dl-link" href="#" target="_blank" class="block text-center bg-green-600 text-white py-2 font-bold hover:bg-green-500">DOWNLOAD JSON</a>
        </div>

        <div class="logs" id="console"></div>
    </div>
</div>

<script>
    // CONFIGURAÇÃO JSONBIN
    const BIN_ID_SERVER = "695c0336d0ea881f40566e09";
    const BIN_ID_KEYS = "69892e1143b1c97be96fd3d0";
    const MASTER_KEY = "$2a$10$uZJCOClc7V9uwqnCnJbXyuHynJ7fX7Z0l32pHbznLAtpLbjX7ABwS";

    let SERVER_URL = "";
    let CURRENT_TYPE = "CREATOR";
    let HWID = localStorage.getItem("hwid") || "WEB-" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("hwid", HWID);

    function log(msg) {
        const c = document.getElementById('console');
        c.innerHTML += `<div>> ${msg}</div>`;
        c.scrollTop = c.scrollHeight;
    }

    async function login() {
        const key = document.getElementById('key-input').value;
        const btn = document.getElementById('btn-login');
        btn.disabled = true;
        btn.innerText = "AUTHENTICATING...";

        try {
            // 1. Busca URL do Ngrok
            log("Fetching Server URL...");
            let r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_SERVER}/latest`, {
                headers: {"X-Master-Key": MASTER_KEY}
            });
            let data = await r.json();
            SERVER_URL = data.record.server_url;
            log(`Server found: ${SERVER_URL}`);

            // 2. Verifica Key
            log("Verifying Key...");
            r = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID_KEYS}/latest`, {
                headers: {"X-Master-Key": MASTER_KEY}
            });
            data = await r.json();
            let user = data.record.users[key];

            if(!user) throw "Invalid Key";
            if(user.type !== "admin" && user.hwid && user.hwid !== HWID) throw "HWID Mismatch";

            // Sucesso
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dash-screen').classList.remove('hidden');
            document.getElementById('status-dot').className = "w-3 h-3 bg-green-500 rounded-full shadow-[0_0_10px_#0f0]";
            
            // Ping Server
            checkServer();

        } catch(e) {
            alert(e);
            btn.disabled = false;
            btn.innerText = "CONNECT TO CLOUD";
        }
    }

    async function checkServer() {
        try {
            await fetch(`${SERVER_URL}/api/stats`);
            log("Connected to Python backend via Ngrok.");
        } catch(e) {
            log("⚠️ Backend seems offline (Ngrok tunnel error?)");
            document.getElementById('status-dot').className = "w-3 h-3 bg-yellow-500 rounded-full";
        }
    }

    function setType(t) {
        CURRENT_TYPE = t;
        document.getElementById('target-input').placeholder = t === 'CREATOR' ? "Username..." : "Codes (Space separated)...";
        document.getElementById('btn-creator').className = t === 'CREATOR' ? "flex-1 bg-white text-black p-2 font-bold" : "flex-1 border border-gray-700 text-gray-500 p-2";
        document.getElementById('btn-codes').className = t === 'CODES' ? "flex-1 bg-white text-black p-2 font-bold" : "flex-1 border border-gray-700 text-gray-500 p-2";
    }

    async function startTask() {
        const target = document.getElementById('target-input').value;
        if(!target) return;

        document.getElementById('btn-start').disabled = true;
        document.getElementById('download-area').classList.add('hidden');
        log("Sending task...");

        try {
            let payloadTarget = target;
            if(CURRENT_TYPE === 'CODES') payloadTarget = target.split(" ");

            let r = await fetch(`${SERVER_URL}/api/request`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ type: CURRENT_TYPE, target: payloadTarget })
            });
            let d = await r.json();
            
            if(d.success) {
                log(`Task ID: ${d.task_id}. Waiting for worker...`);
                poll(d.task_id);
            }
        } catch(e) {
            log("Error sending task.");
            document.getElementById('btn-start').disabled = false;
        }
    }

    function poll(tid) {
        let interval = setInterval(async () => {
            try {
                let r = await fetch(`${SERVER_URL}/api/status/${tid}`);
                let d = await r.json();

                if(d.status === "COMPLETED") {
                    clearInterval(interval);
                    log("✅ Task Finished!");
                    document.getElementById('btn-start').disabled = false;
                    
                    // Configura Download com Link do Ngrok
                    let finalLink = `${SERVER_URL}${d.download_url}`;
                    let linkBtn = document.getElementById('dl-link');
                    linkBtn.href = finalLink;
                    linkBtn.innerText = `DOWNLOAD JSON (${d.worker})`;
                    document.getElementById('download-area').classList.remove('hidden');
                } else if (d.status === "PROCESSING") {
                    log(`Processing by ${d.worker}...`);
                }
            } catch(e) {
                clearInterval(interval);
            }
        }, 2000);
    }
</script>
</body>
</html>
